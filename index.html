<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRM Envia.com - Fulfillment EspaÃ±a</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
}

body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background-color: #f8fafc;
color: #333;
}

.container {
max-width: 1600px;
margin: 0 auto;
padding: 20px;
display: block;
}

.header {
background: linear-gradient(135deg, #1e40af 0%, #3b82f6 50%, #60a5fa 100%);
color: white;
padding: 2rem;
border-radius: 15px;
margin-bottom: 30px;
box-shadow: 0 10px 30px rgba(0,0,0,0.1);
position: relative;
overflow: hidden;
}

.header::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(45deg, rgba(251, 191, 36, 0.1) 0%, rgba(59, 130, 246, 0.1) 100%);
z-index: 1;
}

.header-content {
position: relative;
z-index: 2;
}

.header h1 {
font-size: 2.5rem;
margin-bottom: 0.5rem;
text-align: center;
background: linear-gradient(45deg, #fbbf24, #ffffff);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
font-weight: 700;
}

.header p {
text-align: center;
opacity: 0.9;
font-size: 1.1rem;
}

.tabs {
display: flex;
background: white;
border-radius: 12px;
padding: 5px;
margin-bottom: 30px;
box-shadow: 0 5px 20px rgba(0,0,0,0.1);
overflow-x: auto;
}

.tab {
flex: 1;
min-width: 150px;
padding: 15px 20px;
background: none;
border: none;
cursor: pointer;
border-radius: 8px;
font-size: 1rem;
font-weight: 500;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
gap: 8px;
white-space: nowrap;
}

.tab:hover {
background: #f1f5f9;
}

.tab.active {
background: #3b82f6;
color: white;
box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
}

.tab-content {
display: none;
animation: fadeIn 0.3s ease;
}

.tab-content.active {
display: block;
}

@keyframes fadeIn {
from { opacity: 0; transform: translateY(10px); }
to { opacity: 1; transform: translateY(0); }
}

.controls {
display: flex;
justify-content: space-between;
align-items: center;
background: white;
padding: 25px;
border-radius: 12px;
margin-bottom: 25px;
box-shadow: 0 5px 20px rgba(0,0,0,0.1);
flex-wrap: wrap;
gap: 15px;
}

.search-container {
position: relative;
flex: 1;
min-width: 300px;
}

.search-input {
width: 100%;
padding: 12px 20px 12px 45px;
border: 2px solid #e2e8f0;
border-radius: 8px;
font-size: 1rem;
transition: all 0.3s ease;
}

.search-input:focus {
outline: none;
border-color: #3b82f6;
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.search-icon {
position: absolute;
left: 15px;
top: 50%;
transform: translateY(-50%);
color: #94a3b8;
}

.filters {
display: flex;
gap: 15px;
flex-wrap: wrap;
}

.filter-select {
padding: 12px 15px;
border: 2px solid #e2e8f0;
border-radius: 8px;
font-size: 1rem;
background: white;
min-width: 150px;
cursor: pointer;
transition: all 0.3s ease;
}

.filter-select:focus {
outline: none;
border-color: #3b82f6;
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn {
padding: 12px 24px;
border: none;
border-radius: 8px;
font-size: 1rem;
font-weight: 500;
cursor: pointer;
transition: all 0.3s ease;
text-decoration: none;
display: inline-flex;
align-items: center;
gap: 8px;
}

.btn-primary {
background: #3b82f6;
color: white;
}

.btn-primary:hover {
background: #2563eb;
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
}

.table-container {
background: white;
border-radius: 12px;
overflow: hidden;
box-shadow: 0 5px 20px rgba(0,0,0,0.1);
}

.table {
width: 100%;
border-collapse: collapse;
font-size: 0.9rem;
}

.table th {
background: #f8fafc;
padding: 16px 10px;
text-align: left;
font-weight: 600;
font-size: 0.8rem;
color: #475569;
border-bottom: 2px solid #e2e8f0;
position: sticky;
top: 0;
z-index: 10;
white-space: nowrap;
}

.table td {
padding: 16px 10px;
border-bottom: 1px solid #f1f5f9;
vertical-align: middle;
font-size: 0.85rem;
}

.table tbody tr {
cursor: pointer;
transition: background 0.2s ease;
}

.table tbody tr:hover {
background: #f8fafc;
}

.table tbody tr.expanded {
background: #f1f5f9;
}

.table tbody tr.expanded:hover {
background: #e2e8f0;
}

.lead-details {
padding: 0;
max-height: 0;
overflow: hidden;
transition: all 0.3s ease;
}

.lead-details.active {
padding: 25px;
max-height: 800px;
}

.details-grid {
display: grid;
grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
gap: 20px;
}

.detail-item {
background: white;
padding: 20px;
border-radius: 8px;
box-shadow: 0 2px 10px rgba(0,0,0,0.05);
border: 1px solid #e5e7eb;
}

.detail-item h4 {
color: #3b82f6;
margin-bottom: 15px;
font-size: 1rem;
text-transform: uppercase;
letter-spacing: 0.5px;
border-bottom: 2px solid #e5e7eb;
padding-bottom: 8px;
}

.detail-item p {
color: #1e293b;
font-size: 0.9rem;
margin-bottom: 8px;
line-height: 1.4;
}

.detail-item strong {
color: #374151;
font-weight: 600;
}

.status {
padding: 4px 8px;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 500;
text-transform: uppercase;
letter-spacing: 0.5px;
white-space: nowrap;
}

.status-nuevo { background: #fef3c7; color: #92400e; }
.status-contactado { background: #fde68a; color: #a16207; }
.status-propuesta_enviada { background: #ddd6fe; color: #6b46c1; }
.status-interesado { background: #bfdbfe; color: #1e40af; }
.status-cliente_cerrado { background: #bbf7d0; color: #166534; }
.status-perdido { background: #f3f4f6; color: #6b7280; }

.priority {
padding: 4px 8px;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 500;
text-transform: uppercase;
letter-spacing: 0.5px;
white-space: nowrap;
}

.priority-alta { background: #fecaca; color: #dc2626; }
.priority-media { background: #fed7aa; color: #ea580c; }
.priority-baja { background: #d1fae5; color: #059669; }

.etapa {
padding: 4px 8px;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 500;
color: white;
text-transform: capitalize;
white-space: nowrap;
}

.etapa-primer_contacto { background: #8b5cf6; }
.etapa-primera_reunion { background: #3b82f6; }
.etapa-oferta_comercial { background: #f59e0b; }
.etapa-segunda_reunion { background: #10b981; }
.etapa-negociacion { background: #ef4444; }
.etapa-cierre { background: #059669; }

.task-status {
padding: 4px 8px;
border-radius: 12px;
font-size: 0.75rem;
font-weight: 500;
text-transform: uppercase;
letter-spacing: 0.5px;
white-space: nowrap;
}

.task-status-pendiente { background: #fef3c7; color: #92400e; }
.task-status-completada { background: #bbf7d0; color: #166534; }
.task-status-pospuesta { background: #bfdbfe; color: #1e40af; }

.actions {
display: flex;
gap: 6px;
align-items: center;
}

.action-btn {
padding: 6px;
border: none;
border-radius: 4px;
cursor: pointer;
font-size: 0.9rem;
transition: all 0.3s ease;
display: flex;
align-items: center;
justify-content: center;
width: 30px;
height: 30px;
}

.action-btn:hover {
transform: translateY(-1px);
box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-edit {
background: #3b82f6;
color: white;
}

.btn-delete {
background: #ef4444;
color: white;
}

.modal {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0,0,0,0.5);
z-index: 1000;
animation: fadeIn 0.3s ease;
}

.modal-content {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
background: white;
padding: 30px;
border-radius: 15px;
width: 95%;
max-width: 1200px;
max-height: 90vh;
overflow-y: auto;
box-shadow: 0 25px 50px rgba(0,0,0,0.3);
}

.modal h2 {
margin-bottom: 25px;
color: #1f2937;
font-size: 1.5rem;
text-align: center;
background: #3b82f6;
color: white;
padding: 15px;
border-radius: 8px;
margin: -30px -30px 25px -30px;
}

.form-section {
background: #f8fafc;
padding: 20px;
border-radius: 8px;
margin-bottom: 20px;
border: 1px solid #e5e7eb;
}

.form-section h3 {
color: #3b82f6;
margin-bottom: 15px;
font-size: 1.1rem;
border-bottom: 2px solid #e5e7eb;
padding-bottom: 8px;
}

.form-group {
margin-bottom: 15px;
}

.form-group label {
display: block;
margin-bottom: 6px;
font-weight: 500;
color: #374151;
font-size: 0.9rem;
}

.form-group input,
.form-group select,
.form-group textarea {
width: 100%;
padding: 10px 12px;
border: 2px solid #e5e7eb;
border-radius: 6px;
font-size: 0.9rem;
transition: all 0.3s ease;
font-family: inherit;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
outline: none;
border-color: #3b82f6;
box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-group textarea {
resize: vertical;
min-height: 80px;
}

.form-row {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 15px;
}

.form-row-three {
display: grid;
grid-template-columns: 1fr 1fr 1fr;
gap: 15px;
}

.form-row-four {
display: grid;
grid-template-columns: 1fr 1fr 1fr 1fr;
gap: 15px;
}

.form-actions {
display: flex;
gap: 12px;
justify-content: center;
margin-top: 30px;
padding-top: 20px;
border-top: 2px solid #e5e7eb;
}

.btn-secondary {
background: #6b7280;
color: white;
}

.btn-secondary:hover {
background: #4b5563;
}

.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
gap: 20px;
margin-bottom: 30px;
}

.stat-card {
background: white;
padding: 20px;
border-radius: 12px;
box-shadow: 0 5px 20px rgba(0,0,0,0.1);
text-align: center;
transition: transform 0.3s ease;
border-left: 4px solid #3b82f6;
}

.stat-card:hover {
transform: translateY(-5px);
}

.stat-number {
font-size: 2rem;
font-weight: 700;
color: #3b82f6;
margin-bottom: 8px;
}

.stat-label {
font-size: 0.9rem;
color: #6b7280;
margin-bottom: 5px;
}

.loading {
text-align: center;
padding: 50px;
color: #6b7280;
}

.loading::after {
content: '';
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid #f3f4f6;
border-top: 3px solid #3b82f6;
border-radius: 50%;
animation: spin 1s linear infinite;
margin-left: 10px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.error-message {
background: #fee2e2;
color: #991b1b;
padding: 15px;
border-radius: 8px;
margin: 20px 0;
border: 1px solid #fecaca;
}

.success-message {
background: #d1fae5;
color: #065f46;
padding: 15px;
border-radius: 8px;
margin: 20px 0;
border: 1px solid #a7f3d0;
}

.click-hint {
color: #6b7280;
font-size: 0.8rem;
font-style: italic;
text-align: center;
margin-top: 10px;
}

.calculated-field {
background: #f1f5f9;
border: 2px dashed #94a3b8;
color: #4b5563;
font-style: italic;
}

.empty-state {
text-align: center;
padding: 30px;
color: #6b7280;
}

.empty-state h3 {
margin-bottom: 10px;
color: #374151;
}

.task-card {
padding: 15px;
border-bottom: 1px solid #f1f5f9;
display: flex;
justify-content: space-between;
align-items: center;
transition: all 0.2s ease;
}

.task-card:hover {
background-color: #f8fafc;
}

.task-card-content {
flex: 1;
}

.task-card-title {
font-weight: 600;
margin-bottom: 5px;
display: flex;
align-items: center;
gap: 8px;
}

.task-card-description {
color: #64748b;
font-size: 0.9rem;
}

.task-card-actions {
display: flex;
gap: 10px;
}

.task-card-date {
font-size: 0.8rem;
color: #64748b;
margin-top: 5px;
}

.task-badge {
padding: 2px 8px;
border-radius: 12px;
font-size: 0.7rem;
font-weight: 500;
}

.task-badge-personal {
background: #e0e7ff;
color: #4338ca;
}

.task-badge-lead {
background: #d1fae5;
color: #065f46;
}

@media (max-width: 1200px) {
.table {
font-size: 0.8rem;
}

.table th, .table td {
padding: 12px 8px;
}
}

@media (max-width: 768px) {
.container {
padding: 10px;
}

.controls {
flex-direction: column;
align-items: stretch;
}

.search-container {
min-width: auto;
}

.filters {
justify-content: stretch;
}

.filter-select {
min-width: auto;
flex: 1;
}

.table-container {
overflow-x: auto;
}

.table {
min-width: 1400px;
}

.modal-content {
width: 98%;
margin: 10px;
}

.details-grid {
grid-template-columns: 1fr;
}

.form-row, .form-row-three, .form-row-four {
grid-template-columns: 1fr;
}

#tareas > div:first-child {
grid-template-columns: 1fr;
}
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<div class="header-content">
<h1>ğŸ“¦ Envia.com CRM</h1>
<p>Sistema de GestiÃ³n de Leads - Fulfillment EspaÃ±a</p>
</div>
</div>

<div class="tabs">
<button class="tab active" onclick="showTab('leads')">
ğŸ‘¥ GestiÃ³n de Leads
</button>
<button class="tab" onclick="showTab('tareas')">
ğŸ“… Tareas
</button>
<button class="tab" onclick="showTab('dashboard')">
ğŸ“Š Dashboard
</button>
<button class="tab" onclick="showTab('seguimiento')">
ğŸ“‹ Seguimiento
</button>
<button class="tab" onclick="showTab('reportes')">
ğŸ“ˆ Reportes
</button>
</div>

<div id="loading" class="loading" style="display: none;">
Conectando con Firebase...
</div>

<div id="error-container"></div>

<!-- Tab: GestiÃ³n de Leads -->
<div id="leads" class="tab-content active">
<div class="controls">
<div class="search-container">
<span class="search-icon">ğŸ”</span>
<input type="text" class="search-input" placeholder="Buscar empresa, contacto o salesman..." id="searchInput">
</div>
<div class="filters">
<button class="btn btn-primary" onclick="document.getElementById('excelImport').click()" style="margin-left: 10px;">
    ğŸ“Š Importar desde Excel
</button>
<input type="file" id="excelImport" style="display: none;" accept=".xlsx, .xls, .csv" onchange="importExcel(event)">
<button class="btn btn-secondary" onclick="downloadTemplate()" style="margin-left: 10px;">
    ğŸ“¥ Descargar Plantilla
</button>
<select class="filter-select" id="statusFilter">
<option value="">Todos los estados</option>
<option value="nuevo">Nuevo</option>
<option value="contactado">Contactado</option>
<option value="propuesta_enviada">Propuesta Enviada</option>
<option value="interesado">Interesado</option>
<option value="cliente_cerrado">Cliente Cerrado</option>
<option value="perdido">Perdido</option>
</select>
<select class="filter-select" id="salesmanFilter">
<option value="">Todos los comerciales</option>
<option value="Dulce">Dulce</option>
<option value="Pablo">Pablo</option>
</select>
<select class="filter-select" id="etapaFilter">
<option value="">Todas las etapas</option>
<option value="primer_contacto">Primer Contacto</option>
<option value="primera_reunion">Primera ReuniÃ³n</option>
<option value="oferta_comercial">Oferta Comercial</option>
<option value="segunda_reunion">Segunda ReuniÃ³n</option>
<option value="negociacion">NegociaciÃ³n</option>
<option value="cierre">Cierre</option>
</select>
</div>
<button class="btn btn-primary" onclick="openModal()">
â• Nuevo Lead
</button>
</div>

<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Empresa</th>
<th>Salesman</th>
<th>Etapa</th>
<th>Estado</th>
<th>Tipo Producto</th>
<th>Monto â‚¬</th>
<th>Ã“rdens/Mes</th>
<th>DÃ­as U.C.</th>
<th>Fecha Cierre</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="leadsTable">
<!-- Los datos se cargarÃ¡n aquÃ­ -->
</tbody>
</table>
<div class="click-hint">ğŸ’¡ Haz click en cualquier fila para ver los detalles completos del lead</div>
</div>
</div>

<!-- Tab: Tareas -->
<div id="tareas" class="tab-content">
<div class="controls">
<div style="display: flex; gap: 15px; width: 100%;">
<select class="filter-select" id="taskTypeFilter">
<option value="all">Todas las tareas</option>
<option value="personal">Personales</option>
<option value="lead">De leads</option>
</select>
<select class="filter-select" id="taskDateFilter">
<option value="today">Hoy</option>
<option value="week">Esta semana</option>
<option value="month">Este mes</option>
<option value="overdue">Vencidas</option>
<option value="all">Todas</option>
</select>
<button class="btn btn-primary" onclick="openPersonalTaskModal()" style="margin-left: auto;">
â• Nueva Tarea Personal
</button>
</div>
</div>

<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
<div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
<h2 style="margin-bottom: 20px; color: #1f2937; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
ğŸ“ Tareas Personales
<span style="font-size: 0.9rem; background: #3b82f6; color: white; padding: 3px 8px; border-radius: 12px;" id="personalTasksCount">0</span>
</h2>
<div id="personalTasksList">
<!-- Las tareas personales se cargarÃ¡n aquÃ­ -->
</div>
</div>

<div style="background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);">
<h2 style="margin-bottom: 20px; color: #1f2937; font-size: 1.5rem; display: flex; align-items: center; gap: 10px;">
ğŸ“… Tareas de Leads
<span style="font-size: 0.9rem; background: #3b82f6; color: white; padding: 3px 8px; border-radius: 12px;" id="leadTasksCount">0</span>
</h2>
<div id="leadTasksList">
<!-- Las tareas de leads se cargarÃ¡n aquÃ­ -->
</div>
</div>
</div>

<div class="table-container">
<h3 style="margin-bottom: 15px; color: #1f2937; font-size: 1.2rem;">Todas las tareas</h3>
<table class="table">
<thead>
<tr>
<th>Tipo</th>
<th>DescripciÃ³n</th>
<th>Empresa/Lead</th>
<th>Fecha</th>
<th>Prioridad</th>
<th>Estado</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="allTasksTable">
<!-- Todas las tareas se cargarÃ¡n aquÃ­ -->
</tbody>
</table>
</div>
</div>

<!-- Tab: Dashboard -->
<div id="dashboard" class="tab-content">
<div class="stats-grid">
<div class="stat-card">
<div class="stat-number" id="totalLeads">0</div>
<div class="stat-label">Total Leads</div>
</div>
<div class="stat-card">
<div class="stat-number" id="newLeads">0</div>
<div class="stat-label">Nuevos</div>
</div>
<div class="stat-card">
<div class="stat-number" id="closedLeads">0</div>
<div class="stat-label">Cerrados</div>
</div>
<div class="stat-card">
<div class="stat-number" id="totalValue">0â‚¬</div>
<div class="stat-label">Valor Total</div>
</div>
<div class="stat-card">
<div class="stat-number" id="conversionRate">0%</div>
<div class="stat-label">Tasa de ConversiÃ³n</div>
</div>
<div class="stat-card">
<div class="stat-number" id="averageOrders">0</div>
<div class="stat-label">Promedio Ã“rdenes/Mes</div>
</div>
<div class="stat-card">
<div class="stat-number" id="averageDays">0</div>
<div class="stat-label">DÃ­as Promedio Cierre</div>
</div>
<div class="stat-card">
<div class="stat-number" id="topTier">-</div>
<div class="stat-label">Tier Dominante</div>
</div>
</div>
</div>

<!-- Tab: Seguimiento -->
<div id="seguimiento" class="tab-content">
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Empresa</th>
<th>Fecha Estimada Cierre</th>
<th>DÃ­as Restantes</th>
<th>Salesman</th>
<th>Etapa Actual</th>
<th>Monto</th>
</tr>
</thead>
<tbody id="followUpTable">
<!-- Los datos se cargarÃ¡n aquÃ­ -->
</tbody>
</table>
</div>
</div>

<!-- Tab: Reportes -->
<div id="reportes" class="tab-content">
<div class="stats-grid">
<div class="stat-card">
<div class="stat-label">Mejor Salesman</div>
<div class="stat-number" id="topSalesman">-</div>
</div>
<div class="stat-card">
<div class="stat-label">Fuente MÃ¡s Efectiva</div>
<div class="stat-number" id="bestSource">-</div>
</div>
<div class="stat-card">
<div class="stat-label">Producto MÃ¡s Demandado</div>
<div class="stat-number" id="topProduct">-</div>
</div>
<div class="stat-card">
<div class="stat-label">Tiempo Promedio P.C. a Cierre</div>
<div class="stat-number" id="avgTimeToClose">0 dÃ­as</div>
</div>
</div>
</div>
</div>

<!-- Modal para agregar/editar leads -->
<div id="leadModal" class="modal">
<div class="modal-content">
<h2 id="modalTitle">Agregar Nuevo Lead</h2>
<form id="leadForm">
<!-- InformaciÃ³n BÃ¡sica -->
<div class="form-section">
<h3>ğŸ“‹ InformaciÃ³n BÃ¡sica</h3>
<div class="form-row-three">
<div class="form-group">
<label for="nombreEmpresa">Nombre Empresa *</label>
<input type="text" id="nombreEmpresa" name="nombreEmpresa" required placeholder="Ej: TechCorp SL">
</div>
<div class="form-group">
<label for="salesman">Salesman *</label>
<select id="salesman" name="salesman" required>
<option value="">Seleccionar...</option>
<option value="Dulce">Dulce</option>
<option value="Pablo">Pablo</option>
</select>
</div>
<div class="form-group">
<label for="tipoProducto">Tipo Producto *</label>
<select id="tipoProducto" name="tipoProducto" required>
<option value="">Seleccionar...</option>
<option value="AlimentaciÃ³n y Bebidas">AlimentaciÃ³n y Bebidas</option>
<option value="Belleza y Cuidado Personal">Belleza y Cuidado Personal</option>
<option value="Calzado">Calzado</option>
<option value="ElectrÃ³nica y TecnologÃ­a">ElectrÃ³nica y TecnologÃ­a</option>
<option value="Hogar y DecoraciÃ³n">Hogar y DecoraciÃ³n</option>
<option value="Juguetes y Juegos">Juguetes y Juegos</option>
<option value="Libros y PapelerÃ­a">Libros y PapelerÃ­a</option>
<option value="Materiales de Oficina">Materiales de Oficina</option>
<option value="Productos Naturales">Productos Naturales</option>
<option value="Ropa y Accesorios">Ropa y Accesorios</option>
<option value="Sexshop">Sexshop</option>
<option value="Otros">Otros</option>
</select>
</div>
</div>

<div class="form-row-three">
<div class="form-group">
<label for="fuente">Fuente *</label>
<select id="fuente" name="fuente" required>
<option value="">Seleccionar...</option>
<option value="Referido EnvÃ­a">Referido EnvÃ­a</option>
<option value="Calendly">Calendly</option>
<option value="ProspecciÃ³n">ProspecciÃ³n</option>
<option value="WhatsApp">WhatsApp</option>
<option value="CampaÃ±as de Marketing">CampaÃ±as de Marketing</option>
</select>
</div>
<div class="form-group">
<label for="tier">Tier</label>
<select id="tier" name="tier">
<option value="">Seleccionar...</option>
<option value="T1">Tier 1 (Premium)</option>
<option value="T2">Tier 2 (EstÃ¡ndar)</option>
<option value="T3">Tier 3 (BÃ¡sico)</option>
<option value="T4">Tier 4</option>
</select>
</div>
<div class="form-group">
<label for="diasUC">DÃ­as U.C. *</label>
<input type="number" id="diasUC" name="diasUC" min="0" step="1" placeholder="DÃ­as desde Ãºltimo contacto" required>
</div>
</div>
</div>

<!-- InformaciÃ³n de Contacto -->
<div class="form-section">
<h3>ğŸ“ InformaciÃ³n de Contacto</h3>
<div class="form-row-three">
<div class="form-group">
<label for="nombreContacto">Nombre Contacto</label>
<input type="text" id="nombreContacto" name="nombreContacto" placeholder="Ej: Juan PÃ©rez">
</div>
<div class="form-group">
<label for="cargoContacto">Cargo</label>
<input type="text" id="cargoContacto" name="cargoContacto" placeholder="Ej: Director Comercial">
</div>
<div class="form-group">
<label for="departamentoContacto">Departamento</label>
<input type="text" id="departamentoContacto" name="departamentoContacto" placeholder="Ej: Ventas">
</div>
</div>

<div class="form-row-three">
<div class="form-group">
<label for="telefonoContacto">TelÃ©fono</label>
<input type="tel" id="telefonoContacto" name="telefonoContacto" placeholder="Ej: +34 600 123 456">
</div>
<div class="form-group">
<label for="emailContacto">Email</label>
<input type="email" id="emailContacto" name="emailContacto" placeholder="Ej: contacto@empresa.com">
</div>
<div class="form-group">
<label for="linkedinContacto">LinkedIn</label>
<input type="url" id="linkedinContacto" name="linkedinContacto" placeholder="Ej: https://linkedin.com/in/usuario">
</div>
</div>
</div>

<!-- InformaciÃ³n Comercial -->
<div class="form-section">
<h3>ğŸ’° InformaciÃ³n Comercial</h3>
<div class="form-row-four">
<div class="form-group">
<label for="monto">Monto (â‚¬)</label>
<input type="number" id="monto" name="monto" min="0" step="0.01" placeholder="5000.00">
</div>
<div class="form-group">
<label for="ordenes"># Ã“rdenes/Mes</label>
<input type="number" id="ordenes" name="ordenes" min="0" step="1" placeholder="100">
</div>
<div class="form-group">
<label for="productosOrden">Productos/Orden</label>
<select id="productosOrden" name="productosOrden">
<option value="">Seleccionar...</option>
<option value="1-3">1-3</option>
<option value="3-5">3-5</option>
<option value="6-10">6-10</option>
<option value=">10">>10</option>
</select>
</div>
<div class="form-group">
<label for="posicionesAlmacenamiento"># Posiciones Almacenamiento</label>
<input type="number" id="posicionesAlmacenamiento" name="posicionesAlmacenamiento" min="0" step="1" placeholder="200">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label for="planPicking">Plan Picking</label>
<select id="planPicking" name="planPicking">
<option value="">Seleccionar...</option>
<option value="Basic">Basic</option>
<option value="Pro">Pro</option>
<option value="Enterprise">Enterprise</option>
<option value="Corporate">Corporate</option>
<option value="Custom">Custom</option>
</select>
</div>
<div class="form-group">
<label for="planAlmacenamiento">Plan Almacenamiento</label>
<select id="planAlmacenamiento" name="planAlmacenamiento">
<option value="">Seleccionar...</option>
<option value="Basic">Basic (1-10)</option>
<option value="Pro">Pro (11-30)</option>
<option value="Enterprise">Enterprise (31-100)</option>
<option value="Corporate">Corporate (101-300)</option>
<option value="Custom">Custom (+300)</option>
</select>
</div>
</div>
</div>

<!-- Estados y Etapas -->
<div class="form-section">
<h3>ğŸ“Š Estados y Etapas</h3>
<div class="form-row-three">
<div class="form-group">
<label for="estado">Estado *</label>
<select id="estado" name="estado" required>
<option value="nuevo">Nuevo</option>
<option value="contactado">Contactado</option>
<option value="propuesta_enviada">Propuesta Enviada</option>
<option value="interesado">Interesado</option>
<option value="cliente_cerrado">Cliente Cerrado</option>
<option value="perdido">Perdido</option>
</select>
</div>
<div class="form-group">
<label for="etapaNegociacion">Etapa de NegociaciÃ³n *</label>
<select id="etapaNegociacion" name="etapaNegociacion" required>
<option value="primer_contacto">Primer Contacto</option>
<option value="primera_reunion">Primera ReuniÃ³n</option>
<option value="oferta_comercial">Oferta Comercial</option>
<option value="segunda_reunion">Segunda ReuniÃ³n</option>
<option value="negociacion">NegociaciÃ³n</option>
<option value="cierre">Cierre</option>
</select>
</div>
<div class="form-group">
<label for="gp">G/P (Ganado/Perdido)</label>
<select id="gp" name="gp">
<option value="">En proceso...</option>
<option value="Ganado">Ganado</option>
<option value="Perdido">Perdido</option>
</select>
</div>
</div>
</div>

<!-- Fechas Importantes -->
<div class="form-section">
<h3>ğŸ“… Fechas Importantes</h3>
<div class="form-row-three">
<div class="form-group">
<label for="fechaPrimerContacto">Fecha Primer Contacto</label>
<input type="date" id="fechaPrimerContacto" name="fechaPrimerContacto">
</div>
<div class="form-group">
<label for="fechaPrimeraReunion">Fecha 1ra ReuniÃ³n</label>
<input type="date" id="fechaPrimeraReunion" name="fechaPrimeraReunion">
</div>
<div class="form-group">
<label for="fechaOfertaComercial">Fecha Oferta Comercial</label>
<input type="date" id="fechaOfertaComercial" name="fechaOfertaComercial">
</div>
</div>

<div class="form-row-three">
<div class="form-group">
<label for="fechaSegundaReunion">Fecha 2da ReuniÃ³n</label>
<input type="date" id="fechaSegundaReunion" name="fechaSegundaReunion">
</div>
<div class="form-group">
<label for="fechaNegociacion">Fecha NegociaciÃ³n</label>
<input type="date" id="fechaNegociacion" name="fechaNegociacion">
</div>
<div class="form-group">
<label for="fechaCierre">Fecha de Cierre</label>
<input type="date" id="fechaCierre" name="fechaCierre">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label for="fechaEstimadaCierre">Fecha Estimada de Cierre</label>
<input type="date" id="fechaEstimadaCierre" name="fechaEstimadaCierre">
</div>
<div class="form-group">
<label for="mesEstimado">Mes Estimado</label>
<input type="month" id="mesEstimado" name="mesEstimado">
</div>
</div>
</div>

<!-- MÃ©tricas Calculadas (Solo Lectura) -->
<div class="form-section">
<h3>ğŸ“ˆ MÃ©tricas Calculadas (AutomÃ¡tico)</h3>
<div class="form-row-four">
<div class="form-group">
<label for="pcPrimeraReunion">P.C. a 1er ReuniÃ³n (dÃ­as)</label>
<input type="number" id="pcPrimeraReunion" name="pcPrimeraReunion" readonly class="calculated-field" placeholder="Auto-calculado">
</div>
<div class="form-group">
<label for="primeraReunionOC">1er ReuniÃ³n a O.C. (dÃ­as)</label>
<input type="number" id="primeraReunionOC" name="primeraReunionOC" readonly class="calculated-field" placeholder="Auto-calculado">
</div>
<div class="form-group">
<label for="ocSegundaReunion">O.C. a 2da ReuniÃ³n (dÃ­as)</label>
<input type="number" id="ocSegundaReunion" name="ocSegundaReunion" readonly class="calculated-field" placeholder="Auto-calculado">
</div>
<div class="form-group">
<label for="segundaReunionNeg">2da ReuniÃ³n a Neg (dÃ­as)</label>
<input type="number" id="segundaReunionNeg" name="segundaReunionNeg" readonly class="calculated-field" placeholder="Auto-calculado">
</div>
</div>

<div class="form-row-three">
<div class="form-group">
<label for="negCierre">Neg a Cierre (dÃ­as)</label>
<input type="number" id="negCierre" name="negCierre" readonly class="calculated-field" placeholder="Auto-calculado">
</div>
<div class="form-group">
<label for="diasPCCierre">DÃ­as de P.C. a Cierre</label>
<input type="number" id="diasPCCierre" name="diasPCCierre" readonly class="calculated-field" placeholder="Auto-calculado">
</div>
<div class="form-group">
<label for="prodOrden">#prod/orden</label>
<input type="text" id="prodOrden" name="prodOrden" readonly class="calculated-field" placeholder="Auto-calculado">
</div>
</div>
</div>

<!-- Contadores -->
<div class="form-section">
<h3>ğŸ”¢ Contadores</h3>
<div class="form-row-four">
<div class="form-group">
<label for="contador1raReunion"># 1ra ReuniÃ³n</label>
<input type="number" id="contador1raReunion" name="contador1raReunion" min="0" step="1" placeholder="1">
</div>
<div class="form-group">
<label for="contadorOfertaComercial"># Oferta Comercial</label>
<input type="number" id="contadorOfertaComercial" name="contadorOfertaComercial" min="0" step="1" placeholder="1">
</div>
<div class="form-group">
<label for="contador2daReunion"># 2da ReuniÃ³n</label>
<input type="number" id="contador2daReunion" name="contador2daReunion" min="0" step="1" placeholder="1">
</div>
<div class="form-group">
<label for="contadorNegociacion"># NegociaciÃ³n</label>
<input type="number" id="contadorNegociacion" name="contadorNegociacion" min="0" step="1" placeholder="1">
</div>
</div>

<div class="form-row">
<div class="form-group">
<label for="contadorCierreGanado"># Cierre Ganado</label>
<input type="number" id="contadorCierreGanado" name="contadorCierreGanado" min="0" step="1" placeholder="0">
</div>
<div class="form-group">
<label for="contadorCierrePerdido"># Cierre Perdido</label>
<input type="number" id="contadorCierrePerdido" name="contadorCierrePerdido" min="0" step="1" placeholder="0">
</div>
</div>
</div>

<!-- InformaciÃ³n Adicional -->
<div class="form-section">
<h3>ğŸ“ InformaciÃ³n Adicional</h3>
<div class="form-row-three">
<div class="form-group">
<label for="diaMes">DÃ­a Mes</label>
<input type="number" id="diaMes" name="diaMes" min="1" max="31" placeholder="15">
</div>
<div class="form-group">
<label for="semana">Semana</label>
<input type="week" id="semana" name="semana">
</div>
<div class="form-group">
<label for="fechaUCPC">Fecha U.C.P.C.</label>
<input type="date" id="fechaUCPC" name="fechaUCPC">
</div>
</div>

<div class="form-group">
<label for="comentarios">Comentarios</label>
<div style="border: 2px solid #e5e7eb; border-radius: 8px; overflow: hidden; transition: all 0.3s ease; background: white;" id="notesEditorContainer">
<div id="notesEditor" style="min-height: 150px;"></div>
<div style="display: flex; gap: 10px; margin-top: 10px; padding: 10px; background: #f8fafc; border-top: 1px solid #e5e7eb;">
<button type="button" onclick="downloadNotes()" style="background: #3b82f6; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;">
ğŸ“„ Descargar Notas
</button>
<button type="button" onclick="clearNotes()" style="background: #ef4444; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9rem; cursor: pointer; transition: all 0.2s ease;">
ğŸ—‘ï¸ Limpiar
</button>
<span style="color: #6b7280; font-size: 0.8rem; margin-left: auto; align-self: center;">
Usa la barra de herramientas para formatear el texto
</span>
</div>
</div>
<textarea id="comentarios" name="comentarios" style="display: none;" placeholder="Notas adicionales sobre el lead..."></textarea>
</div>
</div>

<div class="form-actions">
<button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
<button type="submit" class="btn btn-primary">Guardar Lead</button>
</div>
</form>
</div>
</div>

<!-- Modal para tareas personales -->
<div id="personalTaskModal" class="modal">
<div class="modal-content" style="max-width: 600px;">
<h2 id="personalTaskModalTitle">Nueva Tarea Personal</h2>
<form id="personalTaskForm">
<div class="form-group">
<label for="taskTitle">TÃ­tulo *</label>
<input type="text" id="taskTitle" name="title" required placeholder="Ej: Revisar informe mensual">
</div>
<div class="form-group">
<label for="taskDescription">DescripciÃ³n</label>
<textarea id="taskDescription" name="description" rows="3" placeholder="Detalles de la tarea..."></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label for="taskDueDate">Fecha LÃ­mite *</label>
<input type="date" id="taskDueDate" name="dueDate" required>
</div>
<div class="form-group">
<label for="taskPriority">Prioridad *</label>
<select id="taskPriority" name="priority" required>
<option value="alta">Alta</option>
<option value="media" selected>Media</option>
<option value="baja">Baja</option>
</select>
</div>
</div>
<div class="form-actions">
<button type="button" class="btn btn-secondary" onclick="closePersonalTaskModal()">Cancelar</button>
<button type="submit" class="btn btn-primary">Guardar</button>
</div>
</form>
</div>
</div>

<!-- Scripts de Firebase y Editor -->
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.js"></script>
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.2/dist/quill.snow.css" rel="stylesheet">
<script type="module">
// Import the functions you need from the SDKs you need
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy, where } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

// Your web app's Firebase configuration
const firebaseConfig = {
apiKey: "AIzaSyAo-7joP2C-aD5buwmpulrrP2nkNar2kTs",
authDomain: "enviaweeb-crm.firebaseapp.com",
projectId: "enviaweeb-crm",
storageBucket: "enviaweeb-crm.appspot.com",
messagingSenderId: "361625817032",
appId: "1:361625817032:web:5af0c621fd9691d7ec7afd"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Global variables
let leads = [];
let personalTasks = [];
let editingLeadId = null;
let editingTaskId = null;
let notesEditor = null;

// Initialize the app
document.addEventListener('DOMContentLoaded', function() {
    initializeCRM();
});

// Firebase functions
window.firebaseDB = {
    // Get all leads
    async getLeads() {
        try {
            showLoading(true);
            const q = query(collection(db, 'leads'), orderBy('createdAt', 'desc'));
            const querySnapshot = await getDocs(q);
            const leadsData = [];
            querySnapshot.forEach((doc) => {
                leadsData.push({ id: doc.id, ...doc.data() });
            });
            return leadsData;
        } catch (error) {
            console.error('Error getting leads:', error);
            showError('Error al cargar los datos: ' + error.message);
            return [];
        } finally {
            showLoading(false);
        }
    },

    // Get all personal tasks
    async getPersonalTasks() {
        try {
            const q = query(collection(db, 'personalTasks'), orderBy('dueDate', 'asc'));
            const querySnapshot = await getDocs(q);
            const tasksData = [];
            querySnapshot.forEach((doc) => {
                tasksData.push({ id: doc.id, ...doc.data() });
            });
            return tasksData;
        } catch (error) {
            console.error('Error getting personal tasks:', error);
            showError('Error al cargar las tareas personales: ' + error.message);
            return [];
        }
    },

    // Add new lead
    async addLead(leadData) {
        try {
            showLoading(true);
            const docRef = await addDoc(collection(db, 'leads'), {
                ...leadData,
                createdAt: new Date(),
                updatedAt: new Date()
            });
            showSuccess('Lead agregado exitosamente');
            return docRef.id;
        } catch (error) {
            console.error('Error adding lead:', error);
            showError('Error al agregar el lead: ' + error.message);
            throw error;
        } finally {
            showLoading(false);
        }
    },

    // Add new personal task
    async addPersonalTask(taskData) {
        try {
            showLoading(true);
            const docRef = await addDoc(collection(db, 'personalTasks'), {
                ...taskData,
                createdAt: new Date(),
                updatedAt: new Date(),
                completed: false
            });
            showSuccess('Tarea personal agregada exitosamente');
            return docRef.id;
        } catch (error) {
            console.error('Error adding personal task:', error);
            showError('Error al agregar la tarea personal: ' + error.message);
            throw error;
        } finally {
            showLoading(false);
        }
    },

    // Update lead
    async updateLead(leadId, leadData) {
        try {
            showLoading(true);
            const leadRef = doc(db, 'leads', leadId);
            await updateDoc(leadRef, {
                ...leadData,
                updatedAt: new Date()
            });
            showSuccess('Lead actualizado exitosamente');
        } catch (error) {
            console.error('Error updating lead:', error);
            showError('Error al actualizar el lead: ' + error.message);
            throw error;
        } finally {
            showLoading(false);
        }
    },

    // Update personal task
    async updatePersonalTask(taskId, taskData) {
        try {
            showLoading(true);
            const taskRef = doc(db, 'personalTasks', taskId);
            await updateDoc(taskRef, {
                ...taskData,
                updatedAt: new Date()
            });
            showSuccess('Tarea personal actualizada exitosamente');
        } catch (error) {
            console.error('Error updating personal task:', error);
            showError('Error al actualizar la tarea personal: ' + error.message);
            throw error;
        } finally {
            showLoading(false);
        }
    },

    // Delete lead
    async deleteLead(leadId) {
        try {
            showLoading(true);
            const leadRef = doc(db, 'leads', leadId);
            await deleteDoc(leadRef);
            showSuccess('Lead eliminado exitosamente');
        } catch (error) {
            console.error('Error deleting lead:', error);
            showError('Error al eliminar el lead: ' + error.message);
            throw error;
        } finally {
            showLoading(false);
        }
    },

    // Delete personal task
    async deletePersonalTask(taskId) {
        try {
            showLoading(true);
            const taskRef = doc(db, 'personalTasks', taskId);
            await deleteDoc(taskRef);
            showSuccess('Tarea personal eliminada exitosamente');
        } catch (error) {
            console.error('Error deleting personal task:', error);
            showError('Error al eliminar la tarea personal: ' + error.message);
            throw error;
        } finally {
            showLoading(false);
        }
    },

    // Real-time listener for leads
    listenToLeads(callback) {
        const q = query(collection(db, 'leads'), orderBy('createdAt', 'desc'));
        return onSnapshot(q, (querySnapshot) => {
            const leadsData = [];
            querySnapshot.forEach((doc) => {
                leadsData.push({ id: doc.id, ...doc.data() });
            });
            callback(leadsData);
        });
    },

    // Real-time listener for personal tasks
    listenToPersonalTasks(callback) {
        const q = query(collection(db, 'personalTasks'), orderBy('dueDate', 'asc'));
        return onSnapshot(q, (querySnapshot) => {
            const tasksData = [];
            querySnapshot.forEach((doc) => {
                tasksData.push({ id: doc.id, ...doc.data() });
            });
            callback(tasksData);
        });
    }
};

// Initialize the app
async function initializeCRM() {
    // Set up real-time listeners
    window.firebaseDB.listenToLeads((leadsData) => {
        leads = leadsData;
        displayLeads();
        updateStats();
        updateFollowUp();
        updateReports();
        updateTasks();
    });

    window.firebaseDB.listenToPersonalTasks((tasksData) => {
        personalTasks = tasksData;
        updateTasks();
    });

    // Set up event listeners
    setupEventListeners();

    // Initialize notes editor
    initializeNotesEditor();
}

function initializeNotesEditor() {
    // Initialize Quill editor for notes
    if (typeof Quill !== 'undefined' && !notesEditor) {
        const editorElement = document.getElementById('notesEditor');
        if (editorElement && !editorElement.classList.contains('ql-container')) {
            notesEditor = new Quill('#notesEditor', {
                theme: 'snow',
                placeholder: 'Escribe aquÃ­ las notas del lead...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        [{ 'color': [] }, { 'background': [] }],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        [{ 'indent': '-1'}, { 'indent': '+1' }],
                        [{ 'align': [] }],
                        ['link', 'blockquote', 'code-block'],
                        ['clean']
                    ]
                }
            });

            // Update hidden textarea when editor content changes
            notesEditor.on('text-change', function() {
                const htmlContent = notesEditor.root.innerHTML;
                document.getElementById('comentarios').value = htmlContent;
            });
        }
    }
}

function setupEventListeners() {
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', displayLeads);
    document.getElementById('statusFilter').addEventListener('change', displayLeads);
    document.getElementById('salesmanFilter').addEventListener('change', displayLeads);
    document.getElementById('etapaFilter').addEventListener('change', displayLeads);

    // Task filters
    document.getElementById('taskTypeFilter').addEventListener('change', updateTasks);
    document.getElementById('taskDateFilter').addEventListener('change', updateTasks);

    // Form submissions
    document.getElementById('leadForm').addEventListener('submit', handleFormSubmit);
    document.getElementById('personalTaskForm').addEventListener('submit', handlePersonalTaskFormSubmit);

    // Close modals when clicking outside
    document.getElementById('leadModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('leadModal')) {
            closeModal();
        }
    });

    document.getElementById('personalTaskModal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('personalTaskModal')) {
            closePersonalTaskModal();
        }
    });

    // Add event listeners for automatic calculations
    setupCalculationListeners();
}

function setupCalculationListeners() {
    // Date fields that trigger calculations
    const dateFields = [
        'fechaPrimerContacto', 'fechaPrimeraReunion', 'fechaOfertaComercial',
        'fechaSegundaReunion', 'fechaNegociacion', 'fechaCierre'
    ];

    dateFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', calculateMetrics);
        }
    });

    // Product/order calculation
    const productOrderField = document.getElementById('productosOrden');
    if (productOrderField) {
        productOrderField.addEventListener('input', () => {
            document.getElementById('prodOrden').value = productOrderField.value;
        });
    }
}

function calculateMetrics() {
    const fechaPc = document.getElementById('fechaPrimerContacto').value;
    const fecha1ra = document.getElementById('fechaPrimeraReunion').value;
    const fechaOc = document.getElementById('fechaOfertaComercial').value;
    const fecha2da = document.getElementById('fechaSegundaReunion').value;
    const fechaNeg = document.getElementById('fechaNegociacion').value;
    const fechaCierre = document.getElementById('fechaCierre').value;

    // Calculate days between dates
    if (fechaPc && fecha1ra) {
        const days = calculateDaysBetween(fechaPc, fecha1ra);
        document.getElementById('pcPrimeraReunion').value = days;
    }

    if (fecha1ra && fechaOc) {
        const days = calculateDaysBetween(fecha1ra, fechaOc);
        document.getElementById('primeraReunionOC').value = days;
    }

    if (fechaOc && fecha2da) {
        const days = calculateDaysBetween(fechaOc, fecha2da);
        document.getElementById('ocSegundaReunion').value = days;
    }

    if (fecha2da && fechaNeg) {
        const days = calculateDaysBetween(fecha2da, fechaNeg);
        document.getElementById('segundaReunionNeg').value = days;
    }

    if (fechaNeg && fechaCierre) {
        const days = calculateDaysBetween(fechaNeg, fechaCierre);
        document.getElementById('negCierre').value = days;
    }

    if (fechaPc && fechaCierre) {
        const days = calculateDaysBetween(fechaPc, fechaCierre);
        document.getElementById('diasPCCierre').value = days;
    }
}

function calculateDaysBetween(date1, date2) {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    const timeDiff = d2.getTime() - d1.getTime();
    return Math.ceil(timeDiff / (1000 * 3600 * 24));
}

async function handleFormSubmit(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const leadData = Object.fromEntries(formData.entries());

    // Get notes from editor
    if (notesEditor) {
        leadData.comentarios = notesEditor.root.innerHTML;
    }

    // Convert numeric values
    const numericFields = [
        'monto', 'ordenes', 'posicionesAlmacenamiento',
        'diasUC', 'pcPrimeraReunion', 'primeraReunionOC', 'ocSegundaReunion',
        'segundaReunionNeg', 'negCierre', 'diasPCCierre',
        'contador1raReunion', 'contadorOfertaComercial', 'contador2daReunion',
        'contadorNegociacion', 'contadorCierreGanado', 'contadorCierrePerdido',
        'diaMes'
    ];

    numericFields.forEach(field => {
        if (leadData[field]) {
            leadData[field] = parseFloat(leadData[field]) || 0;
        }
    });

    try {
        if (editingLeadId) {
            await window.firebaseDB.updateLead(editingLeadId, leadData);
        } else {
            await window.firebaseDB.addLead(leadData);
        }
        closeModal();
    } catch (error) {
        // Error is already handled in Firebase functions
    }
}

async function handlePersonalTaskFormSubmit(e) {
    e.preventDefault();

    const formData = new FormData(e.target);
    const taskData = Object.fromEntries(formData.entries());

    try {
        if (editingTaskId) {
            await window.firebaseDB.updatePersonalTask(editingTaskId, taskData);
        } else {
            await window.firebaseDB.addPersonalTask(taskData);
        }
        closePersonalTaskModal();
    } catch (error) {
        // Error is already handled in Firebase functions
    }
}

function updateTasks() {
    const taskTypeFilter = document.getElementById('taskTypeFilter').value;
    const taskDateFilter = document.getElementById('taskDateFilter').value;
    const today = new Date().toISOString().split('T')[0];

    // Filter personal tasks based on date filter
    let filteredPersonalTasks = personalTasks.filter(task => {
        if (task.completed) return false;

        if (taskDateFilter === 'today') {
            return task.dueDate === today;
        } else if (taskDateFilter === 'week') {
            const taskDate = new Date(task.dueDate);
            const todayDate = new Date();
            const startOfWeek = new Date(todayDate.setDate(todayDate.getDate() - todayDate.getDay()));
            const endOfWeek = new Date(todayDate.setDate(todayDate.getDate() + 6));
            return taskDate >= startOfWeek && taskDate <= endOfWeek;
        } else if (taskDateFilter === 'month') {
            const taskDate = new Date(task.dueDate);
            const todayDate = new Date();
            return taskDate.getMonth() === todayDate.getMonth() && 
                   taskDate.getFullYear() === todayDate.getFullYear();
        } else if (taskDateFilter === 'overdue') {
            return new Date(task.dueDate) < new Date(today);
        }
        return true;
    });

    // Update personal tasks count
    document.getElementById('personalTasksCount').textContent = filteredPersonalTasks.length;

    // Update personal tasks list
    const personalTasksList = document.getElementById('personalTasksList');
    personalTasksList.innerHTML = '';

    if (filteredPersonalTasks.length === 0) {
        personalTasksList.innerHTML = `
            <div class="empty-state">
                <h3>No hay tareas personales</h3>
                <p>Â¡Buen trabajo! Todo estÃ¡ al dÃ­a.</p>
            </div>
        `;
    } else {
        filteredPersonalTasks.forEach(task => {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-card';
            taskItem.innerHTML = `
                <div class="task-card-content">
                    <div class="task-card-title">
                        <span class="task-badge task-badge-personal">Personal</span>
                        ${task.title}
                    </div>
                    <div class="task-card-description">${task.description || 'Sin descripciÃ³n'}</div>
                    <div class="task-card-date">Fecha lÃ­mite: ${formatDate(task.dueDate)}</div>
                </div>
                <div class="task-card-actions">
                    <button onclick="completePersonalTask('${task.id}')" style="padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; background: #22c55e; color: white;">Completar</button>
                    <button onclick="postponePersonalTask('${task.id}')" style="padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; background: #f59e0b; color: white;">Posponer</button>
                </div>
            `;
            personalTasksList.appendChild(taskItem);
        });
    }

    // Filter lead tasks based on date filter
    let filteredLeadTasks = leads.filter(lead => {
        if (lead.estado === 'cliente_cerrado' || lead.estado === 'perdido') return false;

        if (!lead.fechaEstimadaCierre) return false;

        if (taskDateFilter === 'today') {
            return lead.fechaEstimadaCierre === today;
        } else if (taskDateFilter === 'week') {
            const leadDate = new Date(lead.fechaEstimadaCierre);
            const todayDate = new Date();
            const startOfWeek = new Date(todayDate.setDate(todayDate.getDate() - todayDate.getDay()));
            const endOfWeek = new Date(todayDate.setDate(todayDate.getDate() + 6));
            return leadDate >= startOfWeek && leadDate <= endOfWeek;
        } else if (taskDateFilter === 'month') {
            const leadDate = new Date(lead.fechaEstimadaCierre);
            const todayDate = new Date();
            return leadDate.getMonth() === todayDate.getMonth() && 
                   leadDate.getFullYear() === todayDate.getFullYear();
        } else if (taskDateFilter === 'overdue') {
            return new Date(lead.fechaEstimadaCierre) < new Date(today);
        }
        return true;
    });

    // Update lead tasks count
    document.getElementById('leadTasksCount').textContent = filteredLeadTasks.length;

    // Update lead tasks list
    const leadTasksList = document.getElementById('leadTasksList');
    leadTasksList.innerHTML = '';

    if (filteredLeadTasks.length === 0) {
        leadTasksList.innerHTML = `
            <div class="empty-state">
                <h3>No hay tareas de leads</h3>
                <p>Todas las tareas estÃ¡n al dÃ­a</p>
            </div>
        `;
    } else {
        filteredLeadTasks.forEach(lead => {
            const taskItem = document.createElement('div');
            taskItem.className = 'task-card';
            taskItem.innerHTML = `
                <div class="task-card-content">
                    <div class="task-card-title">
                        <span class="task-badge task-badge-lead">Lead</span>
                        ${lead.nombreEmpresa}
                    </div>
                    <div class="task-card-description">Seguimiento para cierre estimado</div>
                    <div class="task-card-date">Fecha estimada: ${formatDate(lead.fechaEstimadaCierre)}</div>
                </div>
                <div class="task-card-actions">
                    <button onclick="completeLeadTask('${lead.id}')" style="padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; background: #22c55e; color: white;">Completar</button>
                    <button onclick="editLead('${lead.id}')" style="padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.9rem; transition: all 0.2s ease; background: #3b82f6; color: white;">Editar</button>
                </div>
            `;
            leadTasksList.appendChild(taskItem);
        });
    }

    // Update all tasks table
    const allTasksTable = document.getElementById('allTasksTable');
    allTasksTable.innerHTML = '';

    // Combine all tasks
    const allTasks = [
        ...personalTasks.map(task => ({ 
            ...task, 
            type: 'Personal',
            status: task.completed ? 'completada' : new Date(task.dueDate) < new Date() ? 'pendiente (vencida)' : 'pendiente'
        })),
        ...leads.filter(lead => lead.fechaEstimadaCierre && lead.estado !== 'cliente_cerrado' && lead.estado !== 'perdido').map(lead => ({
            id: lead.id,
            title: `Seguimiento ${lead.nombreEmpresa}`,
            description: lead.nombreEmpresa,
            dueDate: lead.fechaEstimadaCierre,
            priority: 'media',
            type: 'Lead',
            status: new Date(lead.fechaEstimadaCierre) < new Date() ? 'pendiente (vencida)' : 'pendiente'
        }))
    ].sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));

    // Apply filters to all tasks table
    let filteredAllTasks = allTasks;

    if (taskTypeFilter !== 'all') {
        filteredAllTasks = filteredAllTasks.filter(task => 
            taskTypeFilter === 'personal' ? task.type === 'Personal' : task.type === 'Lead'
        );
    }

    if (taskDateFilter === 'today') {
        filteredAllTasks = filteredAllTasks.filter(task => task.dueDate === today);
    } else if (taskDateFilter === 'week') {
        const todayDate = new Date();
        const startOfWeek = new Date(todayDate.setDate(todayDate.getDate() - todayDate.getDay()));
        const endOfWeek = new Date(todayDate.setDate(todayDate.getDate() + 6));
        filteredAllTasks = filteredAllTasks.filter(task => {
            const taskDate = new Date(task.dueDate);
            return taskDate >= startOfWeek && taskDate <= endOfWeek;
        });
    } else if (taskDateFilter === 'month') {
        const todayDate = new Date();
        filteredAllTasks = filteredAllTasks.filter(task => {
            const taskDate = new Date(task.dueDate);
            return taskDate.getMonth() === todayDate.getMonth() && 
                   taskDate.getFullYear() === todayDate.getFullYear();
        });
    } else if (taskDateFilter === 'overdue') {
        filteredAllTasks = filteredAllTasks.filter(task => new Date(task.dueDate) < new Date(today));
    }

    if (filteredAllTasks.length === 0) {
        allTasksTable.innerHTML = `
            <tr>
                <td colspan="7" class="empty-state">
                    <h3>No hay tareas programadas</h3>
                    <p>Agrega nuevas tareas para comenzar</p>
                </td>
            </tr>
        `;
        return;
    }

    filteredAllTasks.forEach(task => {
        const isOverdue = new Date(task.dueDate) < new Date();
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><span style="padding: 4px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 500; color: white; background: ${task.type === 'Personal' ? '#6b7280' : '#3b82f6'};">${task.type}</span></td>
            <td>
                <div><strong>${task.title || task.description}</strong></div>
                <div style="color: #6b7280; font-size: 0.9rem;">${task.description || 'Sin descripciÃ³n'}</div>
            </td>
            <td>${task.type === 'Lead' ? task.description : 'Tarea personal'}</td>
            <td style="color: ${isOverdue ? '#ef4444' : '#6b7280'}">${formatDate(task.dueDate)}</td>
            <td><span class="priority priority-${task.priority}">${task.priority.toUpperCase()}</span></td>
            <td><span class="task-status task-status-${task.status.includes('completada') ? 'completada' : task.status.includes('vencida') ? 'pendiente' : 'pendiente'}">${task.status.toUpperCase()}</span></td>
            <td>
                <div class="actions">
                    ${task.type === 'Personal' ? `
                        <button class="action-btn btn-edit" onclick="editPersonalTask('${task.id}')" title="Editar">
                            âœï¸
                        </button>
                        <button class="action-btn btn-delete" onclick="deletePersonalTask('${task.id}')" title="Eliminar">
                            ğŸ—‘ï¸
                        </button>
                    ` : `
                        <button class="action-btn btn-edit" onclick="editLead('${task.id}')" title="Editar">
                            âœï¸
                        </button>
                    `}
                </div>
            </td>
        `;
        allTasksTable.appendChild(row);
    });
}

function completePersonalTask(taskId) {
    if (confirm('Â¿Marcar esta tarea como completada?')) {
        window.firebaseDB.updatePersonalTask(taskId, { completed: true });
    }
}

function postponePersonalTask(taskId) {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const tomorrowStr = tomorrow.toISOString().split('T')[0];

    window.firebaseDB.updatePersonalTask(taskId, { dueDate: tomorrowStr });
}

function completeLeadTask(leadId) {
    const lead = leads.find(l => l.id === leadId);
    if (!lead) return;

    // Move to next stage or mark as closed
    let nextEtapa = lead.etapaNegociacion;
    if (lead.etapaNegociacion === 'primer_contacto') nextEtapa = 'primera_reunion';
    else if (lead.etapaNegociacion === 'primera_reunion') nextEtapa = 'oferta_comercial';
    else if (lead.etapaNegociacion === 'oferta_comercial') nextEtapa = 'segunda_reunion';
    else if (lead.etapaNegociacion === 'segunda_reunion') nextEtapa = 'negociacion';
    else if (lead.etapaNegociacion === 'negociacion') nextEtapa = 'cierre';

    window.firebaseDB.updateLead(leadId, {
        etapaNegociacion: nextEtapa,
        estado: nextEtapa === 'cierre' ? 'cliente_cerrado' : lead.estado
    });
}

// Notes editor functions
window.downloadNotes = function() {
    const textContent = notesEditor ? notesEditor.getText() : (document.getElementById('comentarios')?.value || '');

    if (!textContent.trim()) {
        showError('No hay contenido para descargar');
        return;
    }

    try {
        // Get lead info for filename
        let filename = 'notas-lead';
        let company = 'Sin especificar';
        let salesman = 'Sin especificar';

        if (editingLeadId) {
            const lead = leads.find(l => l.id === editingLeadId);
            if (lead) {
                company = lead.nombreEmpresa || 'Sin especificar';
                salesman = lead.salesman || 'Sin especificar';
                filename = `notas-${lead.nombreEmpresa?.toLowerCase().replace(/\s+/g, '-') || 'lead'}`;
            }
        } else {
            const companyField = document.getElementById('nombreEmpresa');
            const salesmanField = document.getElementById('salesman');
            if (companyField?.value) {
                company = companyField.value;
                filename = `notas-${companyField.value.toLowerCase().replace(/\s+/g, '-')}`;
            }
            if (salesmanField?.value) {
                salesman = salesmanField.value;
            }
        }

        // Create document content
        const documentContent = `
NOTAS DEL LEAD - ENVIA.COM FULFILLMENT
===============================================

ğŸ“‹ INFORMACIÃ“N DEL LEAD:
Empresa: ${company}
Salesman: ${salesman}
Fecha: ${new Date().toLocaleDateString('es-ES')}

===============================================

ğŸ“ CONTENIDO DE LAS NOTAS:

${textContent}

===============================================
Generado por Envia.com CRM - Fulfillment EspaÃ±a
Fecha: ${new Date().toLocaleString('es-ES')}
`;

        // Create and download file
        const blob = new Blob([documentContent], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        showSuccess('Notas descargadas exitosamente');

    } catch (error) {
        console.error('Error downloading notes:', error);
        showError('Error al descargar las notas');
    }
}

window.clearNotes = function() {
    if (notesEditor) {
        if (confirm('Â¿EstÃ¡s seguro de que quieres limpiar todas las notas?')) {
            notesEditor.setText('');
            document.getElementById('comentarios').value = '';
            showSuccess('Notas limpiadas');
        }
    }
}

// Personal task modal functions
window.openPersonalTaskModal = function(taskId = null) {
    editingTaskId = taskId;
    const modal = document.getElementById('personalTaskModal');
    const form = document.getElementById('personalTaskForm');
    const title = document.getElementById('personalTaskModalTitle');
    
    if (taskId) {
        const task = personalTasks.find(t => t.id === taskId);
        if (task) {
            title.textContent = 'Editar Tarea Personal';
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskDueDate').value = task.dueDate || '';
            document.getElementById('taskPriority').value = task.priority || 'media';
        }
    } else {
        title.textContent = 'Nueva Tarea Personal';
        form.reset();
        document.getElementById('taskDueDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('taskPriority').value = 'media';
    }
    
    modal.style.display = 'block';
};

window.closePersonalTaskModal = function() {
    document.getElementById('personalTaskModal').style.display = 'none';
    editingTaskId = null;
};

window.editPersonalTask = function(taskId) {
    openPersonalTaskModal(taskId);
}

window.deletePersonalTask = async function(taskId) {
    if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar esta tarea personal?')) {
        try {
            await window.firebaseDB.deletePersonalTask(taskId);
        } catch (error) {
            // Error is already handled in Firebase functions
        }
    }
}

// Display functions
function displayLeads() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const salesmanFilter = document.getElementById('salesmanFilter').value;
    const etapaFilter = document.getElementById('etapaFilter').value;

    let filteredLeads = leads.filter(lead => {
        const matchesSearch = (lead.nombreEmpresa || '').toLowerCase().includes(searchTerm) ||
                             (lead.salesman || '').toLowerCase().includes(searchTerm) ||
                             (lead.tipoProducto || '').toLowerCase().includes(searchTerm);
        const matchesStatus = !statusFilter || lead.estado === statusFilter;
        const matchesSalesman = !salesmanFilter || lead.salesman === salesmanFilter;
        const matchesEtapa = !etapaFilter || lead.etapaNegociacion === etapaFilter;

        return matchesSearch && matchesStatus && matchesSalesman && matchesEtapa;
    });

    const tbody = document.getElementById('leadsTable');
    tbody.innerHTML = '';

    filteredLeads.forEach(lead => {
        const row = document.createElement('tr');
        row.onclick = () => toggleLeadDetails(lead.id, row);
        row.innerHTML = `
            <td>
                <div><strong>${lead.nombreEmpresa || 'Sin nombre'}</strong></div>
                <div style="color: #6b7280; font-size: 0.8rem;">${lead.fuente || 'N/A'}</div>
            </td>
            <td><strong>${lead.salesman || 'N/A'}</strong></td>
            <td><span class="etapa etapa-${lead.etapaNegociacion || 'primer_contacto'}">${getEtapaText(lead.etapaNegociacion)}</span></td>
            <td><span class="status status-${lead.estado || 'nuevo'}">${getStatusText(lead.estado)}</span></td>
            <td>${lead.tipoProducto || 'N/A'}</td>
            <td><strong>${lead.monto ? formatCurrency(lead.monto) : 'N/A'}</strong></td>
            <td>${lead.ordenes || 'N/A'}</td>
            <td>${lead.diasUC || '0'}</td>
            <td>${lead.fechaEstimadaCierre ? formatDate(lead.fechaEstimadaCierre) : 'N/A'}</td>
            <td>
                <div class="actions">
                    <button class="action-btn btn-edit" onclick="event.stopPropagation(); editLead('${lead.id}')" title="Editar">
                        âœï¸
                    </button>
                    <button class="action-btn btn-delete" onclick="event.stopPropagation(); deleteLead('${lead.id}')" title="Eliminar">
                        ğŸ—‘ï¸
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);

        // Add details row (initially hidden)
        const detailsRow = document.createElement('tr');
        detailsRow.id = `details-${lead.id}`;
        detailsRow.style.display = 'none';
        detailsRow.innerHTML = `
            <td colspan="10">
                <div class="lead-details" id="lead-details-${lead.id}">
                    <div class="details-grid">
                        <div class="detail-item">
                            <h4>InformaciÃ³n BÃ¡sica</h4>
                            <p><strong>Empresa:</strong> ${lead.nombreEmpresa || 'N/A'}</p>
                            <p><strong>Salesman:</strong> ${lead.salesman || 'N/A'}</p>
                            <p><strong>Tipo Producto:</strong> ${lead.tipoProducto || 'N/A'}</p>
                            <p><strong>Fuente:</strong> ${lead.fuente || 'N/A'}</p>
                            <p><strong>Tier:</strong> ${lead.tier || 'N/A'}</p>
                            <p><strong>DÃ­as U.C.:</strong> ${lead.diasUC || '0'}</p>
                        </div>
                        <div class="detail-item">
                            <h4>InformaciÃ³n de Contacto</h4>
                            <p><strong>Nombre:</strong> ${lead.nombreContacto || 'N/A'}</p>
                            <p><strong>Cargo:</strong> ${lead.cargoContacto || 'N/A'}</p>
                            <p><strong>Departamento:</strong> ${lead.departamentoContacto || 'N/A'}</p>
                            <p><strong>TelÃ©fono:</strong> ${lead.telefonoContacto || 'N/A'}</p>
                            <p><strong>Email:</strong> ${lead.emailContacto || 'N/A'}</p>
                            <p><strong>LinkedIn:</strong> ${lead.linkedinContacto || 'N/A'}</p>
                        </div>
                        <div class="detail-item">
                            <h4>InformaciÃ³n Comercial</h4>
                            <p><strong>Monto:</strong> ${lead.monto ? formatCurrency(lead.monto) : 'N/A'}</p>
                            <p><strong>Ã“rdenes/Mes:</strong> ${lead.ordenes || 'N/A'}</p>
                            <p><strong>Productos/Orden:</strong> ${lead.productosOrden || 'N/A'}</p>
                            <p><strong>Posiciones Almacenamiento:</strong> ${lead.posicionesAlmacenamiento || 'N/A'}</p>
                            <p><strong>Plan Picking:</strong> ${lead.planPicking || 'N/A'}</p>
                            <p><strong>Plan Almacenamiento:</strong> ${lead.planAlmacenamiento || 'N/A'}</p>
                        </div>
                        <div class="detail-item">
                            <h4>Estados y Etapas</h4>
                            <p><strong>Estado:</strong> ${getStatusText(lead.estado)}</p>
                            <p><strong>Etapa NegociaciÃ³n:</strong> ${getEtapaText(lead.etapaNegociacion)}</p>
                            <p><strong>G/P:</strong> ${lead.gp || 'En proceso'}</p>
                        </div>
                        <div class="detail-item">
                            <h4>Fechas Importantes</h4>
                            <p><strong>Primer Contacto:</strong> ${lead.fechaPrimerContacto ? formatDate(lead.fechaPrimerContacto) : 'N/A'}</p>
                            <p><strong>1ra ReuniÃ³n:</strong> ${lead.fechaPrimeraReunion ? formatDate(lead.fechaPrimeraReunion) : 'N/A'}</p>
                            <p><strong>Oferta Comercial:</strong> ${lead.fechaOfertaComercial ? formatDate(lead.fechaOfertaComercial) : 'N/A'}</p>
                            <p><strong>2da ReuniÃ³n:</strong> ${lead.fechaSegundaReunion ? formatDate(lead.fechaSegundaReunion) : 'N/A'}</p>
                            <p><strong>NegociaciÃ³n:</strong> ${lead.fechaNegociacion ? formatDate(lead.fechaNegociacion) : 'N/A'}</p>
                            <p><strong>Cierre:</strong> ${lead.fechaCierre ? formatDate(lead.fechaCierre) : 'N/A'}</p>
                            <p><strong>Estimada Cierre:</strong> ${lead.fechaEstimadaCierre ? formatDate(lead.fechaEstimadaCierre) : 'N/A'}</p>
                        </div>
                        <div class="detail-item">
                            <h4>MÃ©tricas Calculadas</h4>
                            <p><strong>P.C. a 1er ReuniÃ³n:</strong> ${lead.pcPrimeraReunion || '0'} dÃ­as</p>
                            <p><strong>1er ReuniÃ³n a O.C.:</strong> ${lead.primeraReunionOC || '0'} dÃ­as</p>
                            <p><strong>O.C. a 2da ReuniÃ³n:</strong> ${lead.ocSegundaReunion || '0'} dÃ­as</p>
                            <p><strong>2da ReuniÃ³n a Neg:</strong> ${lead.segundaReunionNeg || '0'} dÃ­as</p>
                            <p><strong>Neg a Cierre:</strong> ${lead.negCierre || '0'} dÃ­as</p>
                            <p><strong>P.C. a Cierre Total:</strong> ${lead.diasPCCierre || '0'} dÃ­as</p>
                        </div>
                        <div class="detail-item">
                            <h4>Contadores</h4>
                            <p><strong># 1ra ReuniÃ³n:</strong> ${lead.contador1raReunion || '0'}</p>
                            <p><strong># Oferta Comercial:</strong> ${lead.contadorOfertaComercial || '0'}</p>
                            <p><strong># 2da ReuniÃ³n:</strong> ${lead.contador2daReunion || '0'}</p>
                            <p><strong># NegociaciÃ³n:</strong> ${lead.contadorNegociacion || '0'}</p>
                            <p><strong># Cierre Ganado:</strong> ${lead.contadorCierreGanado || '0'}</p>
                            <p><strong># Cierre Perdido:</strong> ${lead.contadorCierrePerdido || '0'}</p>
                        </div>
                        <div class="detail-item" style="grid-column: 1 / -1;">
                            <h4>Comentarios</h4>
                            <p>${lead.comentarios || 'Sin comentarios adicionales'}</p>
                        </div>
                    </div>
                </div>
            </td>
        `;
        tbody.appendChild(detailsRow);
    });
}

function toggleLeadDetails(leadId, row) {
    const detailsRow = document.getElementById(`details-${leadId}`);
    const detailsContent = document.getElementById(`lead-details-${leadId}`);

    // Close all other details
    document.querySelectorAll('[id^="details-"]').forEach(dr => {
        if (dr.id !== `details-${leadId}`) {
            dr.style.display = 'none';
            dr.previousElementSibling.classList.remove('expanded');
            const otherContent = document.querySelector(`#lead-details-${dr.id.split('-')[1]}`);
            if (otherContent) otherContent.classList.remove('active');
        }
    });

    if (detailsRow.style.display === 'none') {
        detailsRow.style.display = 'table-row';
        row.classList.add('expanded');
        setTimeout(() => {
            detailsContent.classList.add('active');
        }, 10);
    } else {
        detailsContent.classList.remove('active');
        row.classList.remove('expanded');
        setTimeout(() => {
            detailsRow.style.display = 'none';
        }, 300);
    }
}

function updateStats() {
    const totalLeads = leads.length;
    const newLeads = leads.filter(lead => lead.estado === 'nuevo').length;
    const closedLeads = leads.filter(lead => lead.estado === 'cliente_cerrado').length;
    const totalValue = leads.reduce((sum, lead) => sum + (lead.monto || 0), 0);
    const conversionRate = totalLeads > 0 ? ((closedLeads / totalLeads) * 100).toFixed(1) : 0;

    // Calculate average orders
    const leadsWithOrders = leads.filter(lead => lead.ordenes && lead.ordenes > 0);
    const averageOrders = leadsWithOrders.length > 0 ? 
        Math.round(leadsWithOrders.reduce((sum, lead) => sum + lead.ordenes, 0) / leadsWithOrders.length) : 0;

    // Calculate average days to close
    const closedLeadsWithDays = leads.filter(lead => lead.diasPCCierre && lead.diasPCCierre > 0);
    const averageDays = closedLeadsWithDays.length > 0 ? 
        Math.round(closedLeadsWithDays.reduce((sum, lead) => sum + lead.diasPCCierre, 0) / closedLeadsWithDays.length) : 0;

    // Find top tier
    const tierCounts = {};
    leads.forEach(lead => {
        if (lead.tier) {
            tierCounts[lead.tier] = (tierCounts[lead.tier] || 0) + 1;
        }
    });
    const topTier = Object.keys(tierCounts).reduce((a, b) => 
        tierCounts[a] > tierCounts[b] ? a : b, '-');

    document.getElementById('totalLeads').textContent = totalLeads;
    document.getElementById('newLeads').textContent = newLeads;
    document.getElementById('closedLeads').textContent = closedLeads;
    document.getElementById('totalValue').textContent = formatCurrency(totalValue);
    document.getElementById('conversionRate').textContent = conversionRate + '%';
    document.getElementById('averageOrders').textContent = averageOrders;
    document.getElementById('averageDays').textContent = averageDays;
    document.getElementById('topTier').textContent = topTier;
}

function updateFollowUp() {
    const followUpLeads = leads.filter(lead => lead.fechaEstimadaCierre);
    const tbody = document.getElementById('followUpTable');
    tbody.innerHTML = '';

    // Sort by estimated close date
    followUpLeads.sort((a, b) => new Date(a.fechaEstimadaCierre) - new Date(b.fechaEstimadaCierre));

    followUpLeads.forEach(lead => {
        const today = new Date();
        const closeDate = new Date(lead.fechaEstimadaCierre);
        const daysRemaining = Math.ceil((closeDate - today) / (1000 * 60 * 60 * 24));

        const row = document.createElement('tr');
        const isOverdue = daysRemaining < 0;

        row.innerHTML = `
            <td><strong>${lead.nombreEmpresa || 'Sin nombre'}</strong></td>
            <td>${formatDate(lead.fechaEstimadaCierre)}</td>
            <td style="color: ${isOverdue ? '#ef4444' : daysRemaining <= 7 ? '#f59e0b' : '#10b981'}">${daysRemaining} dÃ­as</td>
            <td><strong>${lead.salesman || 'N/A'}</strong></td>
            <td><span class="etapa etapa-${lead.etapaNegociacion || 'primer_contacto'}">${getEtapaText(lead.etapaNegociacion)}</span></td>
            <td><strong>${lead.monto ? formatCurrency(lead.monto) : 'N/A'}</strong></td>
        `;
        tbody.appendChild(row);
    });
}

function updateReports() {
    // Calculate top salesman
    const salesmanStats = {};
    leads.forEach(lead => {
        if (lead.salesman) {
            if (!salesmanStats[lead.salesman]) {
                salesmanStats[lead.salesman] = { total: 0, closed: 0, value: 0 };
            }
            salesmanStats[lead.salesman].total++;
            if (lead.estado === 'cliente_cerrado') {
                salesmanStats[lead.salesman].closed++;
                salesmanStats[lead.salesman].value += (lead.monto || 0);
            }
        }
    });

    let topSalesman = '-';
    let maxValue = 0;
    for (const salesman in salesmanStats) {
        if (salesmanStats[salesman].value > maxValue) {
            maxValue = salesmanStats[salesman].value;
            topSalesman = salesman;
        }
    }

    // Calculate best source
    const sourceStats = {};
    leads.forEach(lead => {
        if (lead.fuente) {
            if (!sourceStats[lead.fuente]) {
                sourceStats[lead.fuente] = { total: 0, closed: 0 };
            }
            sourceStats[lead.fuente].total++;
            if (lead.estado === 'cliente_cerrado') {
                sourceStats[lead.fuente].closed++;
            }
        }
    });

    let bestSource = '-';
    let bestConversion = 0;
    for (const source in sourceStats) {
        const conversion = sourceStats[source].total > 0 ? 
            (sourceStats[source].closed / sourceStats[source].total) : 0;
        if (conversion > bestConversion) {
            bestConversion = conversion;
            bestSource = source;
        }
    }

    // Calculate top product
    const productStats = {};
    leads.forEach(lead => {
        if (lead.tipoProducto) {
            productStats[lead.tipoProducto] = (productStats[lead.tipoProducto] || 0) + 1;
        }
    });
    const topProduct = Object.keys(productStats).reduce((a, b) => 
        productStats[a] > productStats[b] ? a : b, '-');

    // Calculate average time to close
    const closedLeadsWithDays = leads.filter(lead => lead.diasPCCierre && lead.diasPCCierre > 0);
    const avgTimeToClose = closedLeadsWithDays.length > 0 ? 
        Math.round(closedLeadsWithDays.reduce((sum, lead) => sum + lead.diasPCCierre, 0) / closedLeadsWithDays.length) : 0;

    document.getElementById('topSalesman').textContent = topSalesman;
    document.getElementById('bestSource').textContent = bestSource;
    document.getElementById('topProduct').textContent = topProduct;
    document.getElementById('avgTimeToClose').textContent = avgTimeToClose + ' dÃ­as';
}

// Modal functions
window.openModal = function(leadId = null) {
    editingLeadId = leadId;
    const modal = document.getElementById('leadModal');
    const form = document.getElementById('leadForm');
    const title = document.getElementById('modalTitle');
    
    if (leadId) {
        const lead = leads.find(l => l.id === leadId);
        if (lead) {
            title.textContent = 'Editar Lead';
            
            // Fill form with existing data
            Object.keys(lead).forEach(key => {
                const field = document.getElementById(key);
                if (field && key !== 'comentarios') {
                    field.value = lead[key] || '';
                }
            });
            
            // Set notes in editor
            if (notesEditor && lead.comentarios) {
                notesEditor.root.innerHTML = lead.comentarios;
            }
        }
    } else {
        title.textContent = 'Agregar Nuevo Lead';
        form.reset();
        
        // Set default values
        document.getElementById('estado').value = 'nuevo';
        document.getElementById('etapaNegociacion').value = 'primer_contacto';
        document.getElementById('diasUC').value = '0';
        
        // Set default date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fechaPrimerContacto').value = today;
    }
    
    modal.style.display = 'block';
};

window.closeModal = function() {
    const form = document.getElementById('leadForm');
    form.reset();
    
    // Clear notes editor
    if (notesEditor) {
        notesEditor.setText('');
    }
    
    document.getElementById('leadModal').style.display = 'none';
    editingLeadId = null;
};

// CRUD functions
window.editLead = function(leadId) {
    openModal(leadId);
}

window.deleteLead = async function(leadId) {
    if (confirm('Â¿EstÃ¡s seguro de que quieres eliminar este lead?')) {
        try {
            await window.firebaseDB.deleteLead(leadId);
        } catch (error) {
            // Error is already handled in Firebase functions
        }
    }
}

// Tab functions
window.showTab = function(tabName) {
    // Remove active class from all tabs
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
    });

    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });

    // Show selected tab
    document.getElementById(tabName).classList.add('active');

    // Add active class to clicked tab
    event.target.classList.add('active');

    // Update tasks when switching to tasks tab
    if (tabName === 'tareas') {
        updateTasks();
    }
}

// Utility functions
function getStatusText(status) {
    const statusMap = {
        'nuevo': 'Nuevo',
        'contactado': 'Contactado',
        'propuesta_enviada': 'Propuesta Enviada',
        'interesado': 'Interesado',
        'cliente_cerrado': 'Cliente Cerrado',
        'perdido': 'Perdido'
    };
    return statusMap[status] || status;
}

function getEtapaText(etapa) {
    const etapaMap = {
        'primer_contacto': 'Primer Contacto',
        'primera_reunion': 'Primera ReuniÃ³n',
        'oferta_comercial': 'Oferta Comercial',
        'segunda_reunion': 'Segunda ReuniÃ³n',
        'negociacion': 'NegociaciÃ³n',
        'cierre': 'Cierre'
    };
    return etapaMap[etapa] || etapa;
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('es-ES', {
        style: 'currency',
        currency: 'EUR'
    }).format(amount || 0);
}

function formatDate(dateString) {
    if (!dateString) return '';
    return new Date(dateString).toLocaleDateString('es-ES');
}

function showLoading(show) {
    const loading = document.getElementById('loading');
    if (show) {
        loading.style.display = 'block';
    } else {
        loading.style.display = 'none';
    }
}

function showError(message) {
    const container = document.getElementById('error-container');
    container.innerHTML = `<div class="error-message">${message}</div>`;
    setTimeout(() => {
        container.innerHTML = '';
    }, 5000);
}

function showSuccess(message) {
    const container = document.getElementById('error-container');
    container.innerHTML = `<div class="success-message">${message}</div>`;
    setTimeout(() => {
        container.innerHTML = '';
    }, 3000);
}

// Sample data insertion (only for demo)
// Funciones para importaciÃ³n desde Excel
async function importExcel(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    try {
        showLoading(true);
        const data = await readExcel(file);
        await processExcelData(data);
        showSuccess('Datos importados correctamente');
    } catch (error) {
        showError('Error al importar: ' + error.message);
    } finally {
        showLoading(false);
        event.target.value = ''; // Reset input
    }
}

function readExcel(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                resolve(jsonData);
            } catch (error) {
                reject(error);
            }
        };
        
        reader.onerror = () => reject(new Error('Error al leer el archivo'));
        reader.readAsArrayBuffer(file);
    });
}

async function processExcelData(data) {
    // Mapeo de columnas de Excel a campos del CRM
    const fieldMappings = {
        'Empresa': 'nombreEmpresa',
        'Salesman': 'salesman',
        'Tipo Producto': 'tipoProducto',
        'Fuente': 'fuente',
        'Tier': 'tier',
        'DÃ­as UC': 'diasUC',
        'Monto': 'monto',
        'Ã“rdenes/Mes': 'ordenes',
        'Productos/Orden': 'productosOrden',
        'Posiciones Almacenamiento': 'posicionesAlmacenamiento',
        'Plan Picking': 'planPicking',
        'Plan Almacenamiento': 'planAlmacenamiento',
        'Nombre Contacto': 'nombreContacto',
        'Cargo Contacto': 'cargoContacto',
        'Departamento Contacto': 'departamentoContacto',
        'TelÃ©fono Contacto': 'telefonoContacto',
        'Email Contacto': 'emailContacto',
        'LinkedIn Contacto': 'linkedinContacto',
        'Fecha Estimada Cierre': 'fechaEstimadaCierre'
    };
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const row of data) {
        const leadData = {};
        
        // Mapear campos
        for (const excelField in fieldMappings) {
            const crmField = fieldMappings[excelField];
            if (row[excelField] !== undefined && row[excelField] !== null && row[excelField] !== '') {
                leadData[crmField] = row[excelField];
            }
        }
        
        // Establecer valores por defecto
        leadData.estado = 'nuevo';
        leadData.etapaNegociacion = 'primer_contacto';
        leadData.createdAt = new Date();
        leadData.updatedAt = new Date();
        
        // Validar campos requeridos
        if (!leadData.nombreEmpresa || !leadData.salesman || !leadData.tipoProducto) {
            console.warn('Fila omitida - faltan campos requeridos:', leadData);
            errorCount++;
            continue;
        }
        
        try {
            // Guardar en Firebase
            await window.firebaseDB.addLead(leadData);
            successCount++;
        } catch (error) {
            console.error('Error al importar fila:', error);
            errorCount++;
        }
    }
    
    showSuccess(`ImportaciÃ³n completada: ${successCount} registros importados, ${errorCount} errores`);
}

function downloadTemplate() {
    // Crear datos de ejemplo
    const templateData = [
        {
            'Empresa': 'Ejemplo S.L.',
            'Salesman': 'Dulce',
            'Tipo Producto': 'AlimentaciÃ³n y Bebidas',
            'Fuente': 'Referido EnvÃ­a',
            'Tier': 'T1',
            'DÃ­as UC': '0',
            'Monto': '5000',
            'Ã“rdenes/Mes': '100',
            'Productos/Orden': '1-3',
            'Posiciones Almacenamiento': '50',
            'Plan Picking': 'Basic',
            'Plan Almacenamiento': 'Basic',
            'Nombre Contacto': 'Juan PÃ©rez',
            'Cargo Contacto': 'Director Comercial',
            'Departamento Contacto': 'Ventas',
            'TelÃ©fono Contacto': '+34 600 123 456',
            'Email Contacto': 'juan.perez@ejemplo.com',
            'LinkedIn Contacto': 'https://linkedin.com/in/juanperez',
            'Fecha Estimada Cierre': '2025-12-31'
        }
    ];
    
    // Crear libro de Excel
    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Plantilla Leads");
    
    // Generar y descargar archivo
    XLSX.writeFile(wb, "Plantilla_Importacion_Leads.xlsx");
}
    ];
    
    // Crear libro de Excel
    const ws = XLSX.utils.json_to_sheet(templateData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Plantilla Leads");
    
    // Generar y descargar archivo
    XLSX.writeFile(wb, "Plantilla_Importacion_Leads.xlsx");
}

window.insertSampleData = async function() {
    const sampleLeads = [
        {
            nombreEmpresa: "TechStore Madrid",
            salesman: "Dulce",
            tipoProducto: "Fulfillment Premium",
            fuente: "Web OrgÃ¡nica",
            tier: "Tier 1",
            diasUC: 5,
            monto: 15000,
            ordenes: 150,
            productosOrden: 3.2,
            posicionesAlmacenamiento: 500,
            planPicking: "Premium",
            planAlmacenamiento: "Dedicado",
            estado: "interesado",
            etapaNegociacion: "oferta_comercial",
            gp: "",
            fechaPrimerContacto: "2025-07-01",
            fechaPrimeraReunion: "2025-07-05",
            fechaOfertaComercial: "2025-07-10",
            fechaEstimadaCierre: "2025-07-30",
            mesEstimado: "2025-07",
            pcPrimeraReunion: 4,
            primeraReunionOC: 5,
            contador1raReunion: 1,
            contadorOfertaComercial: 1,
            nombreContacto: "Juan PÃ©rez",
            cargoContacto: "Director Comercial",
            departamentoContacto: "Ventas",
            telefonoContacto: "+34 600 123 456",
            emailContacto: "juan.perez@techstore.com",
            linkedinContacto: "https://linkedin.com/in/juanperez",
            comentarios: "Cliente muy interesado en soluciÃ³n premium",
            diaMes: 15
        },
        {
            nombreEmpresa: "ModaStyle Barcelona",
            salesman: "Pablo",
            tipoProducto: "Fulfillment BÃ¡sico",
            fuente: "LinkedIn Ads",
            tier: "Tier 2",
            diasUC: 3,
            monto: 8500,
            ordenes: 80,
            productosOrden: 2.1,
            posicionesAlmacenamiento: 200,
            planPicking: "EstÃ¡ndar",
            planAlmacenamiento: "Compartido",
            estado: "contactado",
            etapaNegociacion: "primera_reunion",
            gp: "",
            fechaPrimerContacto: "2025-07-10",
            fechaPrimeraReunion: "2025-07-15",
            fechaEstimadaCierre: "2025-08-15",
            mesEstimado: "2025-08",
            pcPrimeraReunion: 5,
            contador1raReunion: 1,
            nombreContacto: "MarÃ­a GarcÃ­a",
            cargoContacto: "Responsable de LogÃ­stica",
            departamentoContacto: "Operaciones",
            telefonoContacto: "+34 699 987 654",
            emailContacto: "maria.garcia@modastyle.com",
            linkedinContacto: "https://linkedin.com/in/mariagarcia",
            comentarios: "Necesitan soluciÃ³n para su nueva lÃ­nea de productos",
            diaMes: 15
        },
        {
            nombreEmpresa: "SportGear Valencia",
            salesman: "Javi",
            tipoProducto: "LogÃ­stica Integral",
            fuente: "Referido Cliente",
            tier: "Tier 1",
            diasUC: 1,
            monto: 25000,
            ordenes: 300,
            productosOrden: 4.5,
            posicionesAlmacenamiento: 800,
            planPicking: "Premium",
            planAlmacenamiento: "Dedicado",
            estado: "cliente_cerrado",
            etapaNegociacion: "cierre",
            gp: "Ganado",
            fechaPrimerContacto: "2025-06-01",
            fechaPrimeraReunion: "2025-06-05",
            fechaOfertaComercial: "2025-06-12",
            fechaSegundaReunion: "2025-06-18",
            fechaNegociacion: "2025-06-25",
            fechaCierre: "2025-07-01",
            fechaEstimadaCierre: "2025-07-01",
            mesEstimado: "2025-07",
            pcPrimeraReunion: 4,
            primeraReunionOC: 7,
            ocSegundaReunion: 6,
            segundaReunionNeg: 7,
            negCierre: 6,
            diasPCCierre: 30,
            contador1raReunion: 1,
            contadorOfertaComercial: 1,
            contador2daReunion: 1,
            contadorNegociacion: 1,
            contadorCierreGanado: 1,
            nombreContacto: "Carlos MartÃ­nez",
            cargoContacto: "CEO",
            departamentoContacto: "DirecciÃ³n",
            telefonoContacto: "+34 677 555 123",
            emailContacto: "carlos.martinez@sportgear.com",
            linkedinContacto: "https://linkedin.com/in/carlosmartinez",
            comentarios: "Cliente referido muy satisfecho con el servicio",
            diaMes: 1
        }
    ];

    const samplePersonalTasks = [
        {
            title: 'Revisar informe mensual fulfillment',
            description: 'Revisar y aprobar el informe de operaciones del mes',
            dueDate: new Date().toISOString().split('T')[0],
            priority: 'alta',
            completed: false
        },
        {
            title: 'ReuniÃ³n con equipo logÃ­stica',
            description: 'Planificar las mejoras en el proceso de picking',
            dueDate: new Date().toISOString().split('T')[0],
            priority: 'media',
            completed: false
        },
        {
            title: 'Actualizar precios servicios',
            description: 'Revisar y actualizar la tarifa de servicios 2025',
            dueDate: new Date(new Date().setDate(new Date().getDate() + 2)).toISOString().split('T')[0],
            priority: 'baja',
            completed: false
        }
    ];

    try {
        showLoading(true);
        for (const lead of sampleLeads) {
            await window.firebaseDB.addLead(lead);
        }
        for (const task of samplePersonalTasks) {
            await window.firebaseDB.addPersonalTask(task);
        }
        showSuccess('Datos de ejemplo insertados exitosamente');
    } catch (error) {
        showError('Error al insertar datos de ejemplo');
    } finally {
        showLoading(false);
    }
}
</script>
</body>
</html>
